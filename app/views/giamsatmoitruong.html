<!DOCTYPE html>
<html class="dark" lang="vi"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Bảng điều khiển Giám sát Môi trường</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
    darkMode: false, // tắt dark mode cho đỡ u ám
    theme: {
        extend: {
        colors: {
            "primary": "#22c55e",          // xanh lá sáng, clean
            "primary-soft": "#dcfce7",     // xanh nhạt nền
            "background-light": "#ffffff",// nền trắng tinh
            "surface": "#f8fafc",          // nền card
            "border-soft": "#e5e7eb",      // border nhẹ
            "text-main": "#0f172a",        // text chính
            "text-sub": "#475569",         // text phụ
        },
        fontFamily: {
            display: ["Manrope", "sans-serif"]
        },
        borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "0.75rem",
            "xl": "1rem",
        },
        },
    },
    }
    </script>

<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="font-display bg-background-light text-text-main">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="layout-container flex h-full grow flex-col">
<!-- TopNavBar Component -->
<header class="flex items-center justify-between whitespace-nowrap
               border-b border-border-soft
               px-4 sm:px-6 lg:px-10 py-3
               sticky top-0 z-10
               bg-white/90 backdrop-blur-sm shadow-sm">

    <!-- LEFT: Back button + Logo + Title -->
    <div class="flex items-center gap-4 shrink-0 text-text-main">

        <!-- Nút quay lại -->
        <a href="/middle"
           class="flex h-10 w-10 items-center justify-center rounded-lg 
                  bg-primary-soft hover:bg-primary/20 transition-colors">
            <span class="material-symbols-outlined text-xl text-primary">
                arrow_back
            </span>
        </a>

        <!-- Logo -->
        <div class="size-6 text-primary">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H8l4-5v4h3l-4 5z"/>
            </svg>
        </div>

        <!-- Title -->
        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] text-text-main">
            Lớp Học Thông Minh
        </h2>
    </div>

</header>

<main class="flex flex-1 justify-center py-5">
<div class="layout-content-container flex flex-col w-full max-w-7xl flex-1 px-4 sm:px-6 lg:px-8">
<div class="flex flex-wrap items-center justify-between gap-4 py-6">
<div class="flex flex-col gap-2">
<p class="text-gray-900 dark:text-white text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">Bảng điều khiển Giám sát Môi trường</p>
<p class="text-primary/80 dark:text-primary/60 text-base font-normal leading-normal">Dữ liệu thời gian thực về chất lượng môi trường xung quanh bạn.</p>
</div>
<div class="relative">
<select class="appearance-none w-48 rounded-lg border border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-white/5 py-2 pl-4 pr-10 text-sm font-medium text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50" id="room-select">
<option value="room1">Phòng 1</option>
<option value="room2">Phòng 2</option>
</select>
<span class="material-symbols-outlined pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">expand_more</span>
</div>
</div>
<div class="flex flex-wrap items-center gap-3 py-3 overflow-x-auto">
<p class="text-sm font-medium text-gray-600 dark:text-gray-400">Hiển thị dữ liệu cho:</p>
<button class="flex h-9 shrink-0 items-center justify-center gap-x-1.5 rounded-lg bg-primary/20 dark:bg-primary/20 px-4 text-primary dark:text-primary text-sm font-bold">
                        Hôm nay
                    </button>
<button class="flex h-9 shrink-0 items-center justify-center gap-x-1.5 rounded-lg bg-gray-200 dark:bg-white/10 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-white/20 text-sm font-medium">
                        7 ngày qua
                    </button>
<button class="flex h-9 shrink-0 items-center justify-center gap-x-1.5 rounded-lg bg-gray-200 dark:bg-white/10 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-white/20 text-sm font-medium">
                        Tháng này
                    </button>
<button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200 dark:bg-white/10 pl-4 pr-3 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-white/20 text-sm font-medium">
                        Tùy chỉnh
                        <span class="material-symbols-outlined text-base">calendar_today</span>
</button>

<!---------------------------------4 ô dữ liệu số------------------------------------------------------->

<div class="w-full max-w-7xl mx-auto">

    <!-- HÀNG 1: 4 ô chính -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 py-4">

        <!-- Nhiệt độ -->
        <div class="flex flex-col gap-2 rounded-xl p-6 border border-white/10 
                    bg-gray-50 dark:bg-white/5 min-h-[140px]">
            <p class="text-gray-600 dark:text-gray-400 text-base font-medium leading-normal">Nhiệt độ</p>
            <p id="temp-value" class="text-gray-900 dark:text-white text-3xl font-bold leading-tight">0°C</p>
            <p id="temp-change" class="text-green-500 text-sm font-medium flex items-center gap-1">
            </p>
        </div>

        <!-- Độ ẩm -->
        <div class="flex flex-col gap-2 rounded-xl p-6 border border-white/10 
                    bg-gray-50 dark:bg-white/5 min-h-[140px]">
            <p class="text-gray-600 dark:text-gray-400 text-base font-medium">Độ ẩm</p>
            <p id="humi-value" class="text-gray-900 dark:text-white text-3xl font-bold leading-tight">0%</p>
            <p id="humi-change" class="text-red-500 text-sm font-medium flex items-center gap-1">
            </p>
        </div>

        <!-- Áp suất -->
        <div class="flex flex-col gap-2 rounded-xl p-6 border border-white/10 
                    bg-gray-50 dark:bg-white/5 min-h-[140px]">
            <p class="text-gray-600 dark:text-gray-400 text-base font-medium">Áp suất</p>
            <p id="press-value" class="text-gray-900 dark:text-white text-3xl font-bold leading-tight">0 hPa</p>
            <p id="press-change" class="text-green-500 text-sm font-medium flex items-center gap-1">
            </p>
        </div>

        <!-- Ánh sáng -->
        <div class="flex flex-col gap-2 rounded-xl p-6 border border-white/10 
                    bg-gray-50 dark:bg-white/5 min-h-[140px]">
            <p class="text-gray-600 dark:text-gray-400 text-base font-medium">Ánh sáng</p>
            <p id="light-value" class="text-gray-900 dark:text-white text-3xl font-bold leading-tight">0 lux</p>
            <p id="light-change" class="text-green-500 text-sm font-medium flex items-center gap-1"> 
            </p>
        </div>
    </div>

    <!-- HÀNG 2: Ô khí Gas -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 pb-4">
        <div class="flex flex-col gap-2 rounded-xl p-6 border border-white/10 
                    bg-gray-50 dark:bg-white/5 min-h-[140px] lg:col-span-1">
            <p class="text-gray-600 dark:text-gray-400 text-base font-medium">Khí Gas</p>
            <p id="gas-value" class="text-gray-900 dark:text-white text-3xl font-bold leading-tight">0 ppm</p>
            <p id="gas-change" class="text-green-500 text-sm font-medium flex items-center gap-1">
            </p>
        </div>
    </div>

</div>




</div>
<!---------------------------------------------------------------------------------------->

<!---------------------------------5 bảng dữ liệu------------------------------------------------------->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 py-4">

<head>
    <style>
        .fixed-width-num {
            width: 120px;   /* quá đủ cho "29.88°C" */
            display: inline-block;
        }


        .fixed-width-change {
            display: inline-flex;
            min-width: 60px;      /* chứa mũi tên + % */
        }
        .tabular-nums {
            font-variant-numeric: tabular-nums;
        }
        .chart-box {
            width: 100%;
            height: 200px;      /* giữ đúng chiều cao bạn đang dùng */
            position: relative;
        }

        .chart-box canvas {
            width: 100% !important;
            height: 100% !important;
            position: absolute;
            inset: 0;
        }
        .pressure-chart-fix {
            height: 166px;   /* thử 170–180px, tìm mức vừa với bên ánh sáng */
        }


    </style>
</head>

<div class="flex flex-col gap-2 rounded-xl border border-white/10 p-6 bg-gray-50 dark:bg-white/5">
        <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">
            Biến động Nhiệt độ (24 giờ qua)
        </p>

        <div class="flex items-baseline gap-2">
        <p id="temp-24h-current"
            class="text-gray-900 dark:text-white text-3xl font-bold fixed-width-num tabular-nums">
            0°C
        </p>

        <div class="flex gap-1 fixed-width-change">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Hôm nay</p>
        </div>
    </div>



    <div class="flex flex-col gap-4 py-4">
        <!-- Khung cố định chiều cao cho biểu đồ -->
        <div class="w-full" style="height: 200px;">
            <canvas id="chart-temp"></canvas>
        </div>

        <!-- Nhãn giờ -->
        <div class="flex justify-between">
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">00:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">04:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">08:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">12:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">16:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">20:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">24:00</p>
        </div>
    </div>

</div>


<div class="flex flex-col gap-2 rounded-xl border border-white/10 p-6 bg-gray-50 dark:bg-white/5">

    <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">
        Biến động Độ ẩm (24 giờ qua)
    </p>

    <!-- Hàng giá trị + % thay đổi -->
    <div class="flex items-baseline gap-2">

        <!-- GIÁ TRỊ HIỆN TẠI -->
        <p id="humid-24h-current"
           class="text-gray-900 dark:text-white text-3xl font-bold fixed-width-num tabular-nums">
            0%
        </p>

        <!-- HÔM NAY + % thay đổi -->
        <div class="flex gap-1 fixed-width-change">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Hôm nay</p>
        </div>
    </div>

    <!-- BIỂU ĐỒ -->
    <div class="flex flex-col gap-4 py-4">

        <div class="w-full" style="height: 200px;">
            <canvas id="chart-humid"></canvas>
        </div>

        <!-- Nhãn giờ -->
        <div class="flex justify-between">
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">00:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">04:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">08:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">12:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">16:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">20:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">24:00</p>
        </div>
    </div>

</div>

<div class="flex flex-col gap-2 rounded-xl border border-white/10 p-6 bg-gray-50 dark:bg-white/5">
    <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">
        Biến động Áp suất (24 giờ qua)
    </p>

    <div class="flex items-baseline gap-2">
        <p id="pressure-24h-current"
           class="text-gray-900 dark:text-white text-3xl font-bold fixed-width-num tabular-nums">
            0 hPa
        </p>

        <div class="flex gap-1 fixed-width-change">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Hôm nay</p>
        </div>
    </div>

    <div class="flex flex-col gap-4 py-4">
        <div class="chart-box pressure-chart-fix">
            <canvas id="chart-pressure"></canvas>
        </div>


        <div class="flex justify-between">
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">00:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">04:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">08:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">12:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">16:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">20:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">24:00</p>
        </div>
    </div>
</div>



<div class="flex flex-col gap-2 rounded-xl border border-white/10 p-6 bg-gray-50 dark:bg-white/5">
    <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">
        Cường độ Ánh sáng (24 giờ qua)
    </p>

    <div class="flex items-baseline gap-2">
        <p id="light-24h-current"
           class="text-gray-900 dark:text-white text-3xl font-bold fixed-width-num tabular-nums">
            0 lux
        </p>

        <div class="flex gap-1 fixed-width-change">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Hôm nay</p>
        </div>
    </div>

    <div class="flex flex-col gap-4 py-4">
        <div class="chart-box">
            <canvas id="chart-light"></canvas>
        </div>

        <div class="flex justify-between">
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">00:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">04:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">08:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">12:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">16:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">20:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">24:00</p>
        </div>
    </div>
</div>

</div>


<div class="flex flex-col gap-2 rounded-xl border border-white/10 p-6 bg-gray-50 dark:bg-white/5">
    <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">
        Nồng độ Khí Gas trung bình theo giờ
    </p>

    <div class="flex items-baseline gap-2">
        <p id="gas-24h-current"
           class="text-gray-900 dark:text-white text-3xl font-bold fixed-width-num tabular-nums">
            0 ppm
        </p>

        <div class="flex gap-1 fixed-width-change">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Trong 24h</p>

            <p id="gas-24h-change"
               class="text-green-500 text-sm font-medium leading-normal flex items-center gap-1">
                <span class="material-symbols-outlined text-sm">arrow_upward</span>0%
            </p>
        </div>
    </div>

    <div class="flex flex-col gap-4 py-4">
        <div class="w-full" style="height: 200px;">
            <svg id="chart-gas" width="100%" height="100%" viewBox="0 0 500 200"
                 preserveAspectRatio="none">
                <path id="gas-area" fill="rgba(43,238,108,0.12)" stroke="none"></path>
                <path id="gas-line" fill="none" stroke="#2bee6c"
                      stroke-width="3" stroke-linecap="round"></path>
            </svg>
        </div>

        <div class="flex justify-between">
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">00:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">04:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">08:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">12:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">16:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">20:00</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold">24:00</p>
        </div>
    </div>
</div>




</div>
<!---------------------------------------------------------------------------------------->
</main>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function normalize24(data) {
  if (!Array.isArray(data)) return Array(24).fill(null);
  const out = data.slice(0, 24);
  while (out.length < 24) out.push(null);
  return out;
}

const HOUR_LABELS = Array.from({ length: 24 }, (_, i) =>
  String(i).padStart(2, "0") + ":00"
);

function parseNum(v) {
  if (v === null || v === undefined) return null;
  if (typeof v === "string") {
    v = v.trim().replace(",", ".");
  }
  const n = parseFloat(v);
  return Number.isNaN(n) ? null : n;
}

/* ===============================
   3) Gộp baseline + realtime theo giờ
   =============================== */
function mergeData(baseline, rows, fieldName) {
  const hourly = Array.from({ length: 24 }, () => []);

  rows.forEach(r => {
    if (!r || !r.Timestamp) return;

    const time = r.Timestamp.includes(" ")
      ? r.Timestamp.split(" ")[1]
      : r.Timestamp.split("T")[1];
    if (!time) return;

    const h = parseInt(time.split(":")[0], 10);
    if (isNaN(h) || h < 0 || h > 23) return;

    const v = Number(r[fieldName]);
    if (!Number.isNaN(v)) hourly[h].push(v);
  });

  const realtimeAvg = hourly.map(arr =>
    arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null
  );

  const nowH = new Date().getHours();
  const merged = Array(24).fill(null);

  for (let h = 0; h <= nowH; h++) {
    if (realtimeAvg[h] != null) {
      merged[h] = realtimeAvg[h];
    } else if (baseline[h] != null) {
      merged[h] = baseline[h];
    }
  }

  return merged;
}



function updateHourlyInfo(data24, field) {
  if (!Array.isArray(data24)) return;

  const now = new Date();
  const curHour = now.getHours();

  const current = Number(data24[curHour]);
  const prev = Number(data24[curHour - 1]);

  if (!Number.isFinite(current)) return;

  let change = 0;
  if (Number.isFinite(prev) && prev !== 0) {
    change = ((current - prev) / prev) * 100;
  }

  document.getElementById(field.valueId).innerText =
    current.toFixed(1) + field.unit;

  const icon = change >= 0 ? "arrow_upward" : "arrow_downward";
  const color = change >= 0 ? "text-green-500" : "text-red-500";

  const el = document.getElementById(field.changeId);
  if (!el) return;

  el.innerHTML = `
    <span class="material-symbols-outlined text-sm">${icon}</span>
    ${change.toFixed(1)}%
  `;
  el.className =
    `text-sm font-medium leading-normal flex items-center gap-1 ${color}`;
}


/* ===============================
   4) VẼ BIỂU ĐỒ NHIỆT ĐỘ
   =============================== */
let tempChart = null;

function renderTempChart(data24) {
  const ctx = document.getElementById("chart-temp")?.getContext("2d");
  if (!ctx) return;

  if (tempChart) tempChart.destroy();

  tempChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: HOUR_LABELS,
      datasets: [{
        data: normalize24(data24),
        borderColor: "#2bee6c",
        backgroundColor: "rgba(43,238,108,0.12)",
        borderWidth: 3,
        pointRadius: 0,
        tension: 0.35,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false, min: 0, max: 50 } }
    }
  });
}

function updateTempChart(hour, value) {
  if (!tempChart || !Number.isFinite(value)) return;
  tempChart.data.datasets[0].data[hour] = value;
  tempChart.update("none");
}


function startTempChart(baseline) {
  renderTempChart(baseline.temp);
}

//////////////////////////////////////

/* ===============================
   BIỂU ĐỒ ĐỘ ẨM 24 GIỜ
   =============================== */
let humidChart = null;

function renderHumidChart(data24) {
  const ctx = document.getElementById("chart-humid")?.getContext("2d");
  if (!ctx) return;

  if (humidChart) humidChart.destroy();

  humidChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: HOUR_LABELS,
      datasets: [{
        data: normalize24(data24),
        borderColor: "#2bee6c",
        backgroundColor: "rgba(43,238,108,0.12)",
        borderWidth: 3,
        pointRadius: 0,
        tension: 0.35,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false, min: 0, max: 100 } }
    }
  });
}

function updateHumidChart(hour, value) {
  if (!humidChart || !Number.isFinite(value)) return;
  humidChart.data.datasets[0].data[hour] = value;
  humidChart.update("none");
}


function startHumidChart(baseline) {
  renderHumidChart(baseline.humid);
}


/* ===============================
   BIỂU ĐỒ ÁP SUẤT 24 GIỜ
   =============================== */
let pressChart = null;

function renderPressChart(data24) {
  const ctx = document.getElementById("chart-pressure")?.getContext("2d");
  if (!ctx) return;

  if (pressChart) pressChart.destroy();

  pressChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: HOUR_LABELS,
      datasets: [{
        data: normalize24(data24),
        borderColor: "#2bee6c",
        backgroundColor: "rgba(43,238,108,0.12)",
        borderWidth: 3,
        pointRadius: 0,
        tension: 0.35,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false } }
    }
  });
}

function updatePressChart(hour, value) {
  if (!pressChart || !Number.isFinite(value)) return;
  pressChart.data.datasets[0].data[hour] = value;
  pressChart.update("none");
}


function startPressChart(baseline) {
  renderPressChart(baseline.press);
}

/* ===============================
   BIỂU ĐỒ ÁNH SÁNG 24 GIỜ
   =============================== */
let lightChart = null;

function renderLightChart(data24) {
  const ctx = document.getElementById("chart-light")?.getContext("2d");
  if (!ctx) return;

  if (lightChart) lightChart.destroy();

  lightChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: HOUR_LABELS,
      datasets: [{
        data: normalize24(data24),
        borderColor: "#2bee6c",
        backgroundColor: "rgba(43,238,108,0.12)",
        borderWidth: 3,
        pointRadius: 0,
        tension: 0.35,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false } }
    }
  });
}

function updateLightChart(hour, value) {
  if (!lightChart || !Number.isFinite(value)) return;
  lightChart.data.datasets[0].data[hour] = value;
  lightChart.update("none");
}


function startLightChart(baseline) {
  renderLightChart(baseline.light);
}



function renderGasChart(data24) {
    const svgW = 500;
    const svgH = 200;

    const data = data24.slice(0, 24);

    const valid = data.filter(v => v != null);
    const max = valid.length ? Math.max(...valid) : 1;

    let lineParts = [];
    let areaParts = [];

    // tìm giờ cuối có dữ liệu
    let lastIndex = -1;
    for (let i = 23; i >= 0; i--) {
        if (data[i] != null) {
            lastIndex = i;
            break;
        }
    }

    for (let i = 0; i < data.length; i++) {
        const v = data[i];
        const x = (i / 23) * svgW;

        if (v == null) {
            lineParts.push("M" + x + "," + svgH);
            continue;
        }

        const y = svgH - (v / max) * (svgH - 10);

        lineParts.push((lineParts.length ? "L" : "M") + x + "," + y);

        // area chỉ thêm đến lastIndex
        if (i <= lastIndex) {
            areaParts.push(x + "," + y);
        }
    }

    // AREA: chỉ kết thúc tại lastIndex, không kéo tới 24:00
    let areaPath = "M0," + svgH;
    if (areaParts.length > 0) {
        areaPath += " L" + areaParts.join(" L");
        // điểm cuối tại lastIndex
        const endX = (lastIndex / 23) * svgW;
        areaPath += " L" + endX + "," + svgH + " Z";
    }

    const linePath = lineParts.join(" ");

    document.getElementById("gas-line").setAttribute("d", linePath);
    document.getElementById("gas-area").setAttribute("d", areaPath);
}



function startGasChart(baseline, history) {
  const merged = mergeData(baseline.gas, history, "Gas");
  renderGasChart(merged);

  updateHourlyInfo(merged, {
    valueId: "gas-24h-current",
    changeId: "gas-24h-change",
    unit: " ppm"
  });

  setInterval(() => {
    const mergedNow = mergeData(baseline.gas, realtimeBuffer, "Gas");
    updateGasChart(mergedNow);

    updateHourlyInfo(mergedNow, {
      valueId: "gas-24h-current",
      changeId: "gas-24h-change",
      unit: " ppm"
    });
  }, 10000);
}


async function initAllCharts() {
  try {
    const res = await fetch("/api/sensors/bootstrap", { cache: "no-store" });
    const data = await res.json();

    if (!data || data.error) {
      console.error("Bootstrap failed", data?.error);
      return;
    }

    const { baseline, history, latest } = data;

    startTempChart(baseline);
    startHumidChart(baseline);
    startPressChart(baseline);
    startLightChart(baseline);


    // cập nhật số realtime ngay khi load
    document.getElementById("temp-value").innerText  = latest.temp.toFixed(1) + "°C";
    document.getElementById("humi-value").innerText  = latest.humi.toFixed(1) + "%";
    document.getElementById("press-value").innerText = latest.press.toFixed(0) + " hPa";
    document.getElementById("light-value").innerText = latest.light.toFixed(0) + " lux";
    document.getElementById("gas-value").innerText   = latest.gas.toFixed(0) + " ppm";

  } catch (err) {
    console.error("initAllCharts failed", err);
  }
}



////////////////////////////////////



async function fetchData() {
  try {
    const res = await fetch("/api/sensors/latest", { cache: "no-store" });
    if (!res.ok) return;

    const data = await res.json();
    if (!data || !data.timestamp) return;

    // ===== parse dữ liệu (KHÔNG tin Google Sheet) =====
    const temp  = parseNum(data.temp);
    const humi  = parseNum(data.humi);
    const press = parseNum(data.press);
    const light = parseNum(data.light);
    const gas   = parseNum(data.gas);

    /* ===============================
       1️⃣ UPDATE REALTIME CARDS
       =============================== */
    if (temp !== null)
      document.getElementById("temp-value").innerText =
        temp.toFixed(1) + "°C";

    if (humi !== null)
      document.getElementById("humi-value").innerText =
        humi.toFixed(1) + "%";

    if (press !== null)
      document.getElementById("press-value").innerText =
        press.toFixed(0) + " hPa";

    if (light !== null)
      document.getElementById("light-value").innerText =
        light.toFixed(0) + " lux";

    if (gas !== null)
      document.getElementById("gas-value").innerText =
        gas.toFixed(0) + " ppm";

    /* ===============================
   2️⃣ SYNC HEADER 24H TỪ REALTIME CARDS
   =============================== */
    const syncText = (fromId, toId) => {
    const from = document.getElementById(fromId);
    const to   = document.getElementById(toId);
    if (from && to && from.innerText) {
        to.innerText = from.innerText;
    }
    };

    syncText("temp-value",  "temp-24h-current");
    syncText("humi-value",  "humid-24h-current");
    syncText("press-value", "press-24h-current");
    syncText("light-value", "light-24h-current");

    /* ===============================
       3️⃣ UPDATE CHARTS (1 POINT / HOUR)
       =============================== */
    const hour = new Date(data.timestamp).getHours();

    if (temp !== null)  updateTempChart(hour, temp);
    if (humi !== null)  updateHumidChart(hour, humi);
    if (press !== null) updatePressChart(hour, press);
    if (light !== null) updateLightChart(hour, light);

    // gas để sau, không đụng
    if (gas !== null && typeof updateGasChart === "function") {
      updateGasChart(hour, gas);
    }

  } catch (e) {
    console.error("fetchData failed:", e);
  }
}



window.addEventListener("DOMContentLoaded", async () => {
  await initAllCharts();   // render 24h
  fetchData();             // update realtime ngay
  setInterval(fetchData, 10000);
});






</script>

</body></html>